---
import type { CollectionEntry } from "astro:content";
import { getCollection, getEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { useTranslations, getLangFromUrl } from "../i18n/utils";

type Props = { post: CollectionEntry<"blog"> };

const { post } = Astro.props;
const { title, description, pubDate, updatedDate, heroImage, author } =
  post.data;
const authorData = await getEntry(author);

const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);

const slugWithLang = post.id.replace(/\.(md|mdx)$/, "");
const [, ...rest] = slugWithLang.split("/");
const slug = rest.join("/");
const otherLang = currentLang === "en" ? "zh" : "en";

const posts = await getCollection("blog");
const otherLangPost = posts.find(
  (p) => p.id.replace(/\.(md|mdx)$/, "") === `${otherLang}/${slug}`
);
---

<html lang={currentLang}>
  <head>
    <BaseHead title={title} description={description} />
    <style>
      .lang-switcher {
        text-align: center;
        margin-bottom: 1rem;
      }
    </style>
  </head>

  <body>
    <Header />
    <main>
      <article>
        <div class="container">
          {
            heroImage && (
              <img class="rounded-lg w-full" src={heroImage} alt="" />
            )
          }
        </div>
        <div class="container">
          <div class="flex flex-col gap-4 my-4">
            <h1 class="text-2xl md:text-4xl font-semibold">{title}</h1>
            {
              authorData && (
                <a
                  href={`/${currentLang}/authors/${authorData.id}`}
                  class="flex items-center gap-2"
                >
                  <img
                    src={authorData.data.avatar}
                    width={40}
                    height={40}
                    alt={authorData.data.name[currentLang]}
                    class="rounded-full object-cover aspect-square"
                  />
                  <span class="font-semibold text-base">
                    {authorData.data.name[currentLang]}
                  </span>
                </a>
              )
            }
            <div class="text-sm text-gray-500">
              <FormattedDate date={pubDate} />
              {
                updatedDate && (
                  <div class="italic">
                    {t("blog.lastUpdatedOn")}{" "}
                    <FormattedDate date={updatedDate} />
                  </div>
                )
              }
            </div>
          </div>
        </div>
        <div class="container">
          <div class="prose dark:prose-invert">
            <hr />
            {
              otherLangPost && (
                <div class="flex justify-center">
                  <a
                    href={`/${otherLangPost.id.replace(/\.(md|mdx)$/, "")}`}
                    class="text-sm text-gray-500"
                  >
                    {t("blog.readIn").replace(
                      "{lang}",
                      otherLang === "en" ? "English" : "中文"
                    )}
                  </a>
                </div>
              )
            }
            <slot />
          </div>
        </div>
      </article>
    </main>

    <Footer />
  </body>
</html>
